--- keepnote/gui/main_window.py	Sat Aug 14 10:41:15 2010 -0400
+++ keepnote/gui/main_window.py	Fri Aug 20 12:20:17 2010 -0400
@@ -201,14 +201,20 @@
                 self._tray_icon = gtk.StatusIcon()
                 self._tray_icon.set_from_pixbuf(get_resource_pixbuf("keepnote-32x32.png"))
                 self._tray_icon.set_tooltip(keepnote.PROGRAM_NAME)
-                self._tray_icon.connect("activate", self._on_tray_icon_activate)
+                self._statusicon_menu = self.make_statusicon_menu()
+                self._tray_icon.connect("activate", self._on_tray_icon_activate)                
+                self._tray_icon.connect('popup-menu',
+                                        self._on_systray_popup_menu)
 
             self._tray_icon.set_property("visible", self._app.pref.use_systray)
-            
         else:
             self._tray_icon = None
 
 
+    def _on_systray_popup_menu(self, status, button, time):
+        self._statusicon_menu.popup(None, None, None, button, time)
+
+
     def new_viewer(self):
         """Creates a new viewer for this window"""
 
@@ -361,16 +367,27 @@
     def load_preferences(self, first_open=False):
         """Load preferences"""        
 
+        self.setup_systray()
+
         if first_open:
             self.resize(*self._app.pref.window_size)
             if self._app.pref.window_maximized:
                 self.maximize()
+            if self._app.pref.use_systray and self._app.pref.minimize_on_start:
+                self.iconify()
 
-        self.setup_systray()
+#        self.setup_systray()
 
         if self._app.pref.use_systray:
             self.set_property("skip-taskbar-hint", self._app.pref.skip_taskbar)
+
+        self.set_keep_above(self._app.pref.window_keep_above)
         
+        if self._app.pref.window_stick:
+            self.stick()
+        else:
+            self.unstick()
+                
         self.set_recent_notebooks_menu(self._app.pref.recent_notebooks)
 
         self._uimanager.set_force_stock(self._app.pref.use_stock_icons)
@@ -1519,7 +1574,7 @@
        
             
 
-    
+   
     def make_toolbar(self):
         
         # configure toolbar
